## 1. 项目背景与目标

随着业务系统数量增多，系统运行日志、安全日志分散在不同主机和应用中，不利于统一分析和安全审计。
本项目目标是实现一个**简化版综合日志审计系统**，完成日志的**采集、存储、查询、统计和简单告警**，为安全分析和审计提供基础支撑。

------

## 2. 系统总体说明

### 2.1 系统角色

为体现权限控制，设计三类角色：

1. **系统管理员（Admin）**
   - 管理用户与角色
   - 配置日志来源、日志解析规则
   - 配置告警规则、系统参数（如日志保留天数）
2. **安全审计员（Auditor）**
   - 查询、过滤日志
   - 查看统计报表
   - 查看告警信息
   - 导出日志
3. **普通用户**
   - 只读访问与自己相关的日志/告警

### 2.2 日志来源

- **方式一：手工上传日志文件**
  - 用户通过 Web 界面/接口上传文本日志文件（如 Nginx access.log、系统应用日志等）
- **方式二：API 方式写入**
  - 其他系统通过 HTTP API 向本系统上报日志（POST JSON）

系统只要求支持**一两种固定格式**（比如：通用时间 + 日志级别 + 来源 + 内容），无需支持所有现实中的格式。

- Web 应用日志（WEB_APP）：记录 HTTP 访问与用户登录行为；
- 网络日志（NETWORK）：记录主机间网络连接信息（简化 NetFlow）；
- 路由器日志（ROUTER）：记录关键网络设备状态变更（如接口 Up/Down）；
- 防火墙日志（FIREWALL）：记录访问控制策略的允许/拒绝日志；
- 数据库日志（DATABASE）：记录数据库登录与对敏感数据表的访问行为。
- 入侵检测

------

## 3. 功能需求

### 3.1 用户与权限管理

**功能描述：**

- 用户注册/由管理员创建用户
- 用户登录（基于用户名 + 密码）
- 基于角色（Admin / Auditor）的权限控制

**基本需求：**

- 密码加密存储（如使用哈希 + 盐）
- 登录失败提示信息不暴露敏感细节

------

### 3.2 日志采集与接入

#### 3.2.1 日志文件上传

**功能描述：**

- 用户通过页面上传日志文件
- 后端接收文件，按指定格式解析并写入数据库

**基本需求：**

- 支持选择日志来源类型（例如：`应用日志`、`系统日志`、`Web访问日志`）
- 上传成功后给出解析成功/失败条数

#### 3.2.2 API 接口采集

**功能描述：**

- 提供一个 REST API，例如 `POST /api/logs/`
- 接收 JSON 格式日志数据并写入数据库

**数据示例：**

```
{
  "source": "web_app",
  "level": "ERROR",
  "message": "user login failed",
  "ip": "192.168.0.1",
  "timestamp": "2025-11-28T10:20:30"
}
```

**基本需求：**

- 对必填字段做校验（时间、级别、内容等）
- 返回成功/失败状态

------

### 3.3 日志解析与存储

**功能描述：**

- 对上传文件/接口数据进行**格式解析**
- 统一存储到 MySQL 的日志表中

**建议的字段（示例）：**

- `id`：主键
- `source`：日志来源（如 nginx、app、system）
- `level`：日志级别（INFO/WARN/ERROR 等）
- `timestamp`：日志时间
- `ip`：来源 IP（可选）
- `user`：相关用户名（可选）
- `message`：日志内容
- `raw_data`：原始日志行（方便回溯，可选）

**要求：**

- 基础解析出错的记录可以：
  - 标记为“解析失败”，或
  - 直接丢弃但记录失败数量（任选其一）

------

### 3.4 日志查询与过滤

**功能描述：**

- 提供页面或接口进行日志搜索

**支持的查询条件（建议）：**

- 时间区间（开始时间、结束时间）
- 日志级别（多选：INFO/WARN/ERROR…）
- 日志来源（source）
- 关键字搜索（message 模糊匹配）
- IP 地址（可选）

**其他要求：**

- 结果分页展示（避免一次性查太多）
- 支持导出当前查询结果为 CSV/Excel（至少提供 CSV 下载接口）

------

### 3.5 日志统计与可视化（简化）

**功能描述：**

- 提供基础统计图表，辅助审计员快速感知整体情况

**建议实现的统计：**

1. **按时间的日志数量趋势**
   - 比如最近 24 小时 / 最近 7 天，每小时/每天的日志条数折线图
2. **按日志级别统计**
   - 各级别（INFO/WARN/ERROR）的数量柱状图或饼图

------

### 3.6 告警规则与告警展示

#### 3.6.1 告警规则配置

***

示例：

1. 某 IP 在 5 分钟内登录失败超过 5 次 → 触发“暴力破解嫌疑”告警
2. 日志级别为 ERROR 的记录直接生成“错误日志告警”

对学生作业来说，可以这样简化：

- 告警规则**写死在代码里**，不做复杂的动态配置界面
- 告警触发后写入 `alert` 表即可，不需要真正发邮件/短信

#### 3.6.2 告警列表与详情

**功能描述：**

- 提供告警列表页/接口
- 基本字段：
  - 告警 ID
  - 告警类型（如暴力破解、错误日志）
  - 告警级别（中/高）
  - 触发时间
  - 关联 IP / 用户 / 日志条数
- 支持按时间和类型过滤

**可选功能：**

- 告警状态：未处理/已处理（Auditor 可以手动标记）

------

### 3.7 审计与操作日志

**功能描述：**

- 记录系统用户的关键操作，便于后续审计

**建议记录内容：**

- 用户登录/登出操作
- 上传日志文件操作（文件名、时间、解析条数）
- 删除日志（如果有删除功能）
- 修改系统配置（若实现）

**存储到独立表** `operation_log`，字段示例：

- `id`
- `user_id`
- `action`（如 LOGIN、UPLOAD_LOG、CHANGE_CONFIG）
- `detail`（详细描述）
- `timestamp`
- `ip`

------

### 3.8 系统配置（可适当简化）

**功能描述：**

- 系统管理员可以配置一些全局参数（也可以写死在配置文件中）

**可选配置项：**

- 日志保留天数（例如：超过 90 天的日志可标记为过期或定期删除）
- 告警规则参数（例如：登录失败次数阈值）
- 日志文件最大上传大小

> 如果时间紧张，这块完全可以不做界面，只用配置文件 + 注释说明。

------

## 4. 非功能需求

### 4.1 安全性

- 用户密码必须使用哈希算法存储（如 bcrypt、PBKDF2 等）
- 接口要进行基本的输入校验，避免 SQL 注入
- 重要操作需要登录态（基于 Token/JWT）
- 简单的错误处理，避免把堆栈信息直接返回给前端

### 4.2 性能与可扩展性（按课程标准）

- 支持至少**数万条日志数据**的查询（分页 + 合理索引）
- 常用查询字段（时间、级别、来源）建立索引
- 日志解析应能处理至少几 MB 的单个文件上传

### 4.3 可用性

- 提供基础 Web 界面或 Postman 接口文档
- 界面不需要花哨，但操作流程清晰（上传 → 查询 → 查看告警）

### 4.4 可维护性

- 后端使用 FastAPI 按模块划分：
  - `auth` 模块（认证、用户管理）
  - `logs` 模块（日志采集、查询）
  - `alert` 模块（告警逻辑）
  - `admin` 模块（系统配置）
- 配置项（数据库连接、日志保留时间等）集中在配置文件中

------

## 5. 技术选型

- 后端框架：**FastAPI**
- 前端：Vue + Echarts
- 数据库：**MySQL**
- ORM（任选其一）：
  - SQLAlchemy / SQLModel / Tortoise ORM
- 接口风格：RESTful API
- 部署方式：
  - 开发环境：Uvicorn 本地启动
  - 可以使用 Docker（可选，加分项）
